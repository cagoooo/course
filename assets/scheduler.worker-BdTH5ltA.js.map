{"version":3,"file":"scheduler.worker-BdTH5ltA.js","sources":["../src/algorithms/types.js","../src/algorithms/ConstraintChecker.js","../src/algorithms/GeneticAlgorithm.js","../src/workers/scheduler.worker.js"],"sourcesContent":["/**\r\n * @typedef {Object} Gene\r\n * Represents a single period for a single class.\r\n * @property {string} classId - The class ID (e.g., \"G1-C1\")\r\n * @property {number} periodIndex - 0 to 34 (Mon 1-7 ... Fri 1-7)\r\n * @property {string|null} courseId - The course ID (e.g., \"Chinese\") or null for empty\r\n * @property {string|null} teacherId - The teacher ID or null\r\n */\r\n\r\n/**\r\n * @typedef {Gene[]} Chromosome\r\n * A flat array of Genes representing the entire school schedule.\r\n * Length = NumClasses * NumPeriodsPerWeek\r\n */\r\n\r\n/**\r\n * @typedef {Object} ScheduleConfig\r\n * Configuration for the scheduling run.\r\n * @property {number} periodsPerDay - Default 7\r\n * @property {number} daysPerWeek - Default 5\r\n * @property {Object} constraints - Hard/Soft constraints settings\r\n */\r\n\r\nexport const PERIODS_PER_DAY = 7;\r\nexport const DAYS_PER_WEEK = 5;\r\nexport const TOTAL_PERIODS = PERIODS_PER_DAY * DAYS_PER_WEEK;\r\n\r\n/**\r\n * Helper to get day index from period index\r\n * @param {number} periodIndex \r\n * @returns {number} 0-4\r\n */\r\nexport const getDayIndex = (periodIndex) => Math.floor(periodIndex / PERIODS_PER_DAY);\r\n\r\n/**\r\n * Helper to get time slot index from period index (0-6)\r\n * @param {number} periodIndex \r\n * @returns {number} 0-6\r\n */\r\nexport const getTimeSlotIndex = (periodIndex) => periodIndex % PERIODS_PER_DAY;\r\n\r\n/**\r\n * Check if a period slot is allowed for a specific grade.\r\n * @param {number} grade 1-6\r\n * @param {number} periodIndex 0-34\r\n * @returns {boolean}\r\n */\r\nexport const isSlotAllowed = (grade, periodIndex) => {\r\n    const dayIndex = getDayIndex(periodIndex);\r\n    const timeSlot = getTimeSlotIndex(periodIndex); // 0-6 (0=Period 1, 4=Period 5)\r\n\r\n    // Global Rule: Wednesday Afternoon (Day 2, Slots 4-6) is OFF for EVERYONE\r\n    if (dayIndex === 2 && timeSlot >= 4) return false;\r\n\r\n    // Grades 1, 2:\r\n    // Tue (Day 1) Full Day.\r\n    // Mon, Wed, Thu, Fri (0, 2, 3, 4) Half Day (Afternoon OFF).\r\n    if (grade === 1 || grade === 2) {\r\n        if (dayIndex !== 1 && timeSlot >= 4) return false;\r\n    }\r\n\r\n    // Grades 3, 4:\r\n    // Fri (Day 4) Half Day.\r\n    // Wed (Day 2) Half Day (Already covered by global rule).\r\n    // Mon, Tue, Thu Full Day.\r\n    if (grade === 3 || grade === 4) {\r\n        if (dayIndex === 4 && timeSlot >= 4) return false;\r\n    }\r\n\r\n    // Grades 5, 6:\r\n    // Typically Wed Half Day (Covered by global).\r\n    // Others Full Day.\r\n    // No extra restrictions.\r\n\r\n    return true;\r\n};\r\n","import { getDayIndex, TOTAL_PERIODS } from './types.js';\r\n\r\n/**\r\n * Calculates fitness score for a chromosome.\r\n * Higher is better.\r\n * Score = Base - (Hard * 10000) - (Soft * 10)\r\n */\r\nexport class ConstraintChecker {\r\n    constructor(config) {\r\n        this.config = config || {};\r\n        this.teachersMap = new Map();\r\n        this.coursesMap = new Map();\r\n        this.classroomsMap = new Map();\r\n    }\r\n\r\n    setTeachers(teachers) {\r\n        this.teachersMap.clear();\r\n        if (teachers && Array.isArray(teachers)) {\r\n            teachers.forEach(t => this.teachersMap.set(t.id, t));\r\n        }\r\n    }\r\n\r\n    setCourses(courses) {\r\n        this.coursesMap.clear();\r\n        if (courses && Array.isArray(courses)) {\r\n            courses.forEach(c => this.coursesMap.set(c.id, c));\r\n        }\r\n    }\r\n\r\n    setClassrooms(classrooms) {\r\n        this.classroomsMap.clear();\r\n        if (classrooms && Array.isArray(classrooms)) {\r\n            classrooms.forEach(c => this.classroomsMap.set(c.id, c));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param {import('./types').Chromosome} chromosome \r\n     * @returns {number} fitness score\r\n     */\r\n    calculateFitness(chromosome) {\r\n        let hardPenalties = 0;\r\n        let softPenalties = 0;\r\n\r\n        // 1. Teacher Conflicts (Hard)\r\n        const periodTeacherMap = new Map();\r\n        const periodClassroomMap = new Map();\r\n\r\n        // 3. Distribution & Block Periods (Soft)\r\n        // Map: classId -> courseId -> [slotIndices]\r\n        const classCourseSlots = new Map();\r\n\r\n        // One pass validation\r\n        for (const gene of chromosome) {\r\n            if (!gene.teacherId) continue; // Empty slot\r\n\r\n            // Check Teacher Conflict & Availability\r\n            if (gene.teacherId !== '0' && gene.teacherId !== '1') {\r\n                const key = `${gene.periodIndex}-${gene.teacherId}`;\r\n                if (periodTeacherMap.has(key)) {\r\n                    hardPenalties++;\r\n                } else {\r\n                    periodTeacherMap.set(key, 1);\r\n                }\r\n\r\n                const teacher = this.teachersMap.get(gene.teacherId);\r\n                if (teacher) {\r\n                    // Availability (Hard Constraint - Red)\r\n                    if (teacher.unavailableSlots && teacher.unavailableSlots.includes(gene.periodIndex)) {\r\n                        hardPenalties += 5;\r\n                    }\r\n                    // Avoid Preference (Soft Constraint - Yellow)\r\n                    if (teacher.avoidSlots && teacher.avoidSlots.includes(gene.periodIndex)) {\r\n                        softPenalties += 3; // Light penalty for preferring not to have class\r\n                    }\r\n                    // Classroom Conflict (NEW)\r\n                    if (teacher.classroomId) {\r\n                        const classroomKey = `${gene.periodIndex}-${teacher.classroomId}`;\r\n                        if (periodClassroomMap.has(classroomKey)) {\r\n                            hardPenalties += 20; // Specialized Classroom overlap\r\n                        } else {\r\n                            periodClassroomMap.set(classroomKey, 1);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Track for Constraints\r\n            if (!classCourseSlots.has(gene.classId)) {\r\n                classCourseSlots.set(gene.classId, new Map());\r\n            }\r\n            const courseMap = classCourseSlots.get(gene.classId);\r\n            if (!courseMap.has(gene.courseId)) {\r\n                courseMap.set(gene.courseId, []);\r\n            }\r\n            courseMap.get(gene.courseId).push(gene.periodIndex);\r\n        }\r\n\r\n        // Calculate Soft Penalties (Distribution & Block Periods)\r\n        for (const [classId, courseMap] of classCourseSlots) {\r\n            for (const [courseId, slots] of courseMap) {\r\n                const days = slots.map(s => getDayIndex(s));\r\n                const uniqueDays = new Set(days);\r\n\r\n                // Identify Course Name to check for 1+2 (Social/Science) or 2 (Art)\r\n                const course = this.coursesMap?.get(courseId);\r\n                const courseName = course ? (typeof course.name === 'string' ? course.name : (course.name?.name || '')) : '';\r\n                const isBlockSubject = courseName && (courseName.includes('社') || courseName.includes('自'));\r\n                const isArtSubject = courseName && (courseName.includes('美') || courseName.includes('藝'));\r\n\r\n                if (isBlockSubject && slots.length === 3) {\r\n                    // Check for 1+2 pattern: Two consecutive in same day, one in different day\r\n                    const sortedSlots = [...slots].sort((a, b) => a - b);\r\n                    let foundConsecutive = false;\r\n\r\n                    for (let i = 0; i < sortedSlots.length - 1; i++) {\r\n                        const s1 = sortedSlots[i];\r\n                        const s2 = sortedSlots[i + 1];\r\n                        // Same day and consecutive (i, i+1) and not crossing lunch\r\n                        if (getDayIndex(s1) === getDayIndex(s2) && (s2 - s1 === 1) && (s1 % 7 !== 3)) {\r\n                            foundConsecutive = true;\r\n                            break;\r\n                        }\r\n                    }\r\n\r\n                    if (!foundConsecutive) {\r\n                        softPenalties += 8;\r\n                    } else if (uniqueDays.size !== 2) {\r\n                        softPenalties += 4;\r\n                    } else {\r\n                        const daysArr = Array.from(uniqueDays).sort((a, b) => a - b);\r\n                        if (daysArr[1] - daysArr[0] === 1) {\r\n                            softPenalties += 2;\r\n                        }\r\n                    }\r\n                } else if (isArtSubject && slots.length === 2) {\r\n                    // Art: Prefer afternoon and consecutive\r\n                    const sortedSlots = [...slots].sort((a, b) => a - b);\r\n                    const s1 = sortedSlots[0];\r\n                    const s2 = sortedSlots[1];\r\n\r\n                    if (s1 % 7 < 4 || s2 % 7 < 4) {\r\n                        softPenalties += 50; // Afternoon preference (strong)\r\n                    }\r\n\r\n                    if (getDayIndex(s1) !== getDayIndex(s2) || (s2 - s1 !== 1) || (s1 % 7 === 3)) {\r\n                        softPenalties += 30; // Consecutive preference\r\n                    }\r\n                } else if (courseName.includes('國') || courseName.includes('語')) {\r\n                    const dayCount = {};\r\n                    days.forEach(d => {\r\n                        dayCount[d] = (dayCount[d] || 0) + 1;\r\n                    });\r\n                    for (const [day, count] of Object.entries(dayCount)) {\r\n                        // Strong penalty for > 2 periods/day\r\n                        if (count > 2) softPenalties += (count - 2) * 2000;\r\n                    }\r\n                    // Strong preference for daily Chinese class (if load >= 5)\r\n                    if (slots.length >= 5 && uniqueDays.size < 5) {\r\n                        softPenalties += (5 - uniqueDays.size) * 200;\r\n                    }\r\n                } else if (courseName.includes('數')) {\r\n                    const dayCount = {};\r\n                    days.forEach(d => {\r\n                        dayCount[d] = (dayCount[d] || 0) + 1;\r\n                    });\r\n                    for (const [day, count] of Object.entries(dayCount)) {\r\n                        // Strong penalty for > 1 period/day\r\n                        if (count > 1) softPenalties += (count - 1) * 2000;\r\n                    }\r\n                } else {\r\n                    if (uniqueDays.size < slots.length) {\r\n                        softPenalties += (slots.length - uniqueDays.size);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return 1000000 - (hardPenalties * 10000) - (softPenalties * 10);\r\n    }\r\n}\r\n","import { ConstraintChecker } from './ConstraintChecker.js';\r\nimport { TOTAL_PERIODS, getDayIndex, isSlotAllowed } from './types.js';\r\n\r\nexport class GeneticAlgorithm {\r\n    constructor(config) {\r\n        this.config = config || {};\r\n        this.checker = new ConstraintChecker();\r\n        this.populationSize = this.config.populationSize || 50;\r\n        this.mutationRate = this.config.mutationRate || 0.01;\r\n        this.elitism = true;\r\n    }\r\n\r\n    // --- Initialization ---\r\n\r\n    /**\r\n     * Create initial population.\r\n     * @param {Object} data Source data (classes, courses, requirements)\r\n     */\r\n    initPopulation(data) {\r\n        if (data.teachers) this.checker.setTeachers(data.teachers);\r\n        if (data.courses) this.checker.setCourses(data.courses);\r\n        if (data.classrooms) this.checker.setClassrooms(data.classrooms);\r\n\r\n        const population = [];\r\n        for (let i = 0; i < this.populationSize; i++) {\r\n            population.push(this.createRandomSchedule(data));\r\n        }\r\n        return population;\r\n    }\r\n\r\n    createRandomSchedule(data) {\r\n        const classSchedules = {};\r\n        data.classes.forEach(c => {\r\n            classSchedules[c.id] = new Array(TOTAL_PERIODS).fill(null);\r\n        });\r\n\r\n        const classGradeMap = Object.fromEntries(data.classes.map(c => [c.id, c.grade]));\r\n\r\n        // First Pass: Place Locked/Fixed Slots\r\n        data.requirements.forEach(req => {\r\n            if (req.fixedSlots && req.fixedSlots.length > 0) {\r\n                req.fixedSlots.forEach(slotIndex => {\r\n                    if (slotIndex >= 0 && slotIndex < TOTAL_PERIODS) {\r\n                        if (classSchedules[req.classId][slotIndex] === null) {\r\n                            classSchedules[req.classId][slotIndex] = {\r\n                                classId: req.classId,\r\n                                periodIndex: slotIndex,\r\n                                courseId: req.courseId,\r\n                                teacherId: req.teacherId,\r\n                                locked: true\r\n                            };\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        // Second Pass: Randomly place remaining periods\r\n        data.requirements.forEach(req => {\r\n            let count = req.periodsNeeded;\r\n            if (req.fixedSlots) count -= req.fixedSlots.length;\r\n            if (count <= 0) return;\r\n\r\n            const grade = classGradeMap[req.classId] || 1;\r\n            const teacher = data.teachers?.find(t => t.id === req.teacherId);\r\n            const unavailable = teacher?.unavailableSlots || [];\r\n\r\n            let attempts = 0;\r\n            while (count > 0 && attempts < 1000) {\r\n                attempts++;\r\n                const pIndex = Math.floor(Math.random() * TOTAL_PERIODS);\r\n\r\n                // Basic Heuristic: Avoid teacher unavailable slots during initialization if possible\r\n                if (isSlotAllowed(grade, pIndex) && classSchedules[req.classId][pIndex] === null) {\r\n                    // Start with an extra check: try to avoid teacher's busy time in the first 100 attempts\r\n                    if (attempts < 100 && unavailable.includes(pIndex)) continue;\r\n\r\n                    classSchedules[req.classId][pIndex] = {\r\n                        classId: req.classId,\r\n                        periodIndex: pIndex,\r\n                        courseId: req.courseId,\r\n                        teacherId: req.teacherId,\r\n                        locked: false\r\n                    };\r\n                    count--;\r\n                }\r\n            }\r\n        });\r\n\r\n        // Flatten\r\n        const chromosome = [];\r\n        Object.values(classSchedules).forEach(slots => {\r\n            slots.forEach(s => { if (s) chromosome.push(s); });\r\n        });\r\n        return chromosome;\r\n    }\r\n\r\n    // --- Evolution ---\r\n\r\n    evolve(population) {\r\n        // 1. Calculate Fitness\r\n        const scored = population.map(p => ({\r\n            dna: p,\r\n            score: this.checker.calculateFitness(p)\r\n        }));\r\n\r\n        // Sort desc\r\n        scored.sort((a, b) => b.score - a.score);\r\n\r\n        // Elitism: Keep top 1\r\n        const newPop = [scored[0].dna];\r\n\r\n        // Fill rest\r\n        while (newPop.length < this.populationSize) {\r\n            const p1 = this.select(scored);\r\n            const p2 = this.select(scored);\r\n            const child = this.crossover(p1, p2);\r\n            this.mutate(child);\r\n            newPop.push(child);\r\n        }\r\n\r\n        return {\r\n            bestScore: scored[0].score,\r\n            bestSolution: scored[0].dna,\r\n            population: newPop\r\n        };\r\n    }\r\n\r\n    select(scoredPopulation) {\r\n        // Tournament Selection\r\n        const k = 3;\r\n        let best = null;\r\n        for (let i = 0; i < k; i++) {\r\n            const rand = scoredPopulation[Math.floor(Math.random() * scoredPopulation.length)];\r\n            if (!best || rand.score > best.score) best = rand;\r\n        }\r\n        return best.dna;\r\n    }\r\n\r\n    /**\r\n     * Class-based Crossover\r\n     * Maintains course counts by inheriting entire class schedules.\r\n     */\r\n    crossover(p1, p2) {\r\n        // Group by classId\r\n        const groupGenes = (dna) => {\r\n            const map = {};\r\n            dna.forEach(g => {\r\n                if (!map[g.classId]) map[g.classId] = [];\r\n                map[g.classId].push({ ...g });\r\n            });\r\n            return map;\r\n        };\r\n\r\n        const maps1 = groupGenes(p1);\r\n        const maps2 = groupGenes(p2);\r\n        const childDna = [];\r\n\r\n        Object.keys(maps1).forEach(classId => {\r\n            // 50% chance to inherit from p1 or p2\r\n            const source = Math.random() < 0.5 ? maps1 : maps2;\r\n            if (source[classId]) {\r\n                childDna.push(...source[classId]);\r\n            }\r\n        });\r\n\r\n        return childDna;\r\n    }\r\n\r\n    /**\r\n     * Smart Swap Mutation\r\n     * Swaps two periods within the same class to maintain course counts.\r\n     */\r\n    mutate(chromosome) {\r\n        if (Math.random() >= this.mutationRate) return;\r\n\r\n        // Group by class to ensure we swap within same class\r\n        const classIds = [...new Set(chromosome.map(g => g.classId))];\r\n        const targetClassId = classIds[Math.floor(Math.random() * classIds.length)];\r\n\r\n        const classGenes = chromosome.filter(g => g.classId === targetClassId);\r\n        if (classGenes.length < 2) return;\r\n\r\n        // Pick two genes to swap their periodIndex\r\n        const idxA = Math.floor(Math.random() * classGenes.length);\r\n        let idxB = Math.floor(Math.random() * classGenes.length);\r\n        while (idxB === idxA) idxB = Math.floor(Math.random() * classGenes.length);\r\n\r\n        const geneA = classGenes[idxA];\r\n        const geneB = classGenes[idxB];\r\n\r\n        if (!geneA.locked && !geneB.locked) {\r\n            const temp = geneA.periodIndex;\r\n            geneA.periodIndex = geneB.periodIndex;\r\n            geneB.periodIndex = temp;\r\n        }\r\n    }\r\n}\r\n","import { GeneticAlgorithm } from '../algorithms/GeneticAlgorithm.js';\r\n\r\nlet ga = null;\r\nlet running = false;\r\n\r\nself.onmessage = (e) => {\r\n    const { type, payload } = e.data;\r\n\r\n    if (type === 'START') {\r\n        const { data, config } = payload;\r\n        console.log('Worker: Starting GA...', config);\r\n\r\n        console.log('Worker: Initializing GA engine...');\r\n        ga = new GeneticAlgorithm(config);\r\n        // Initialize population and generation when starting\r\n        let population = ga.initPopulation(data); // Fix method name and add let\r\n        let generation = 0;\r\n        let lastBestScore = -1;\r\n        running = true; // Set running to true when starting\r\n\r\n        const tick = () => {\r\n            if (!running) return;\r\n\r\n            try {\r\n                const result = ga.evolve(population);\r\n                population = result.population;\r\n                generation++;\r\n\r\n                // Notify UI every 10 generations, or if a new best score is found\r\n                if (generation % 10 === 0 || result.bestScore > lastBestScore) {\r\n                    lastBestScore = result.bestScore;\r\n                    self.postMessage({\r\n                        type: 'PROGRESS',\r\n                        payload: {\r\n                            generation,\r\n                            bestScore: result.bestScore,\r\n                            bestSolution: result.bestSolution\r\n                        }\r\n                    });\r\n                }\r\n\r\n                setTimeout(tick, 0);\r\n            } catch (err) {\r\n                console.error('Worker Error during evolution:', err);\r\n                running = false;\r\n            }\r\n        };\r\n\r\n        // Start the evolution process\r\n        setTimeout(tick, 0);\r\n        console.log('Worker: Loop initialized.');\r\n    }\r\n};\r\n"],"names":["getDayIndex","periodIndex","getTimeSlotIndex","isSlotAllowed","grade","dayIndex","timeSlot","ConstraintChecker","config","teachers","courses","c","classrooms","chromosome","hardPenalties","softPenalties","periodTeacherMap","periodClassroomMap","classCourseSlots","gene","key","teacher","classroomKey","courseMap","classId","courseId","slots","days","s","uniqueDays","course","courseName","isBlockSubject","isArtSubject","sortedSlots","a","b","foundConsecutive","i","s1","s2","daysArr","dayCount","d","day","count","GeneticAlgorithm","data","population","classSchedules","classGradeMap","req","slotIndex","unavailable","t","attempts","pIndex","scored","p","newPop","p1","p2","child","scoredPopulation","best","rand","groupGenes","dna","map","g","maps1","maps2","childDna","source","classIds","targetClassId","classGenes","idxA","idxB","geneA","geneB","temp","ga","running","e","type","payload","generation","lastBestScore","tick","result","err"],"mappings":"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"}