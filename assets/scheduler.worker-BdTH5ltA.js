(function(){"use strict";const m=p=>Math.floor(p/7),R=p=>p%7,b=(p,e)=>{const t=m(e),o=R(e);return!(t===2&&o>=4||(p===1||p===2)&&t!==1&&o>=4||(p===3||p===4)&&t===4&&o>=4)};class k{constructor(e){this.config=e||{},this.teachersMap=new Map,this.coursesMap=new Map,this.classroomsMap=new Map}setTeachers(e){this.teachersMap.clear(),e&&Array.isArray(e)&&e.forEach(t=>this.teachersMap.set(t.id,t))}setCourses(e){this.coursesMap.clear(),e&&Array.isArray(e)&&e.forEach(t=>this.coursesMap.set(t.id,t))}setClassrooms(e){this.classroomsMap.clear(),e&&Array.isArray(e)&&e.forEach(t=>this.classroomsMap.set(t.id,t))}calculateFitness(e){let t=0,o=0;const i=new Map,s=new Map,c=new Map;for(const n of e){if(!n.teacherId)continue;if(n.teacherId!=="0"&&n.teacherId!=="1"){const r=`${n.periodIndex}-${n.teacherId}`;i.has(r)?t++:i.set(r,1);const l=this.teachersMap.get(n.teacherId);if(l&&(l.unavailableSlots&&l.unavailableSlots.includes(n.periodIndex)&&(t+=5),l.avoidSlots&&l.avoidSlots.includes(n.periodIndex)&&(o+=3),l.classroomId)){const f=`${n.periodIndex}-${l.classroomId}`;s.has(f)?t+=20:s.set(f,1)}}c.has(n.classId)||c.set(n.classId,new Map);const a=c.get(n.classId);a.has(n.courseId)||a.set(n.courseId,[]),a.get(n.courseId).push(n.periodIndex)}for(const[n,a]of c)for(const[r,l]of a){const f=l.map(d=>m(d)),g=new Set(f),E=this.coursesMap?.get(r),I=E?typeof E.name=="string"?E.name:E.name?.name||"":"",O=I&&(I.includes("社")||I.includes("自")),w=I&&(I.includes("美")||I.includes("藝"));if(O&&l.length===3){const d=[...l].sort((h,S)=>h-S);let u=!1;for(let h=0;h<d.length-1;h++){const S=d[h],M=d[h+1];if(m(S)===m(M)&&M-S===1&&S%7!==3){u=!0;break}}if(!u)o+=8;else if(g.size!==2)o+=4;else{const h=Array.from(g).sort((S,M)=>S-M);h[1]-h[0]===1&&(o+=2)}}else if(w&&l.length===2){const d=[...l].sort((S,M)=>S-M),u=d[0],h=d[1];(u%7<4||h%7<4)&&(o+=50),(m(u)!==m(h)||h-u!==1||u%7===3)&&(o+=30)}else if(I.includes("國")||I.includes("語")){const d={};f.forEach(u=>{d[u]=(d[u]||0)+1});for(const[u,h]of Object.entries(d))h>2&&(o+=(h-2)*2e3);l.length>=5&&g.size<5&&(o+=(5-g.size)*200)}else if(I.includes("數")){const d={};f.forEach(u=>{d[u]=(d[u]||0)+1});for(const[u,h]of Object.entries(d))h>1&&(o+=(h-1)*2e3)}else g.size<l.length&&(o+=l.length-g.size)}return 1e6-t*1e4-o*10}}class P{constructor(e){this.config=e||{},this.checker=new k,this.populationSize=this.config.populationSize||50,this.mutationRate=this.config.mutationRate||.01,this.elitism=!0}initPopulation(e){e.teachers&&this.checker.setTeachers(e.teachers),e.courses&&this.checker.setCourses(e.courses),e.classrooms&&this.checker.setClassrooms(e.classrooms);const t=[];for(let o=0;o<this.populationSize;o++)t.push(this.createRandomSchedule(e));return t}createRandomSchedule(e){const t={};e.classes.forEach(s=>{t[s.id]=new Array(35).fill(null)});const o=Object.fromEntries(e.classes.map(s=>[s.id,s.grade]));e.requirements.forEach(s=>{s.fixedSlots&&s.fixedSlots.length>0&&s.fixedSlots.forEach(c=>{c>=0&&c<35&&t[s.classId][c]===null&&(t[s.classId][c]={classId:s.classId,periodIndex:c,courseId:s.courseId,teacherId:s.teacherId,locked:!0})})}),e.requirements.forEach(s=>{let c=s.periodsNeeded;if(s.fixedSlots&&(c-=s.fixedSlots.length),c<=0)return;const n=o[s.classId]||1,r=e.teachers?.find(f=>f.id===s.teacherId)?.unavailableSlots||[];let l=0;for(;c>0&&l<1e3;){l++;const f=Math.floor(Math.random()*35);if(b(n,f)&&t[s.classId][f]===null){if(l<100&&r.includes(f))continue;t[s.classId][f]={classId:s.classId,periodIndex:f,courseId:s.courseId,teacherId:s.teacherId,locked:!1},c--}}});const i=[];return Object.values(t).forEach(s=>{s.forEach(c=>{c&&i.push(c)})}),i}evolve(e){const t=e.map(i=>({dna:i,score:this.checker.calculateFitness(i)}));t.sort((i,s)=>s.score-i.score);const o=[t[0].dna];for(;o.length<this.populationSize;){const i=this.select(t),s=this.select(t),c=this.crossover(i,s);this.mutate(c),o.push(c)}return{bestScore:t[0].score,bestSolution:t[0].dna,population:o}}select(e){let o=null;for(let i=0;i<3;i++){const s=e[Math.floor(Math.random()*e.length)];(!o||s.score>o.score)&&(o=s)}return o.dna}crossover(e,t){const o=n=>{const a={};return n.forEach(r=>{a[r.classId]||(a[r.classId]=[]),a[r.classId].push({...r})}),a},i=o(e),s=o(t),c=[];return Object.keys(i).forEach(n=>{const a=Math.random()<.5?i:s;a[n]&&c.push(...a[n])}),c}mutate(e){if(Math.random()>=this.mutationRate)return;const t=[...new Set(e.map(r=>r.classId))],o=t[Math.floor(Math.random()*t.length)],i=e.filter(r=>r.classId===o);if(i.length<2)return;const s=Math.floor(Math.random()*i.length);let c=Math.floor(Math.random()*i.length);for(;c===s;)c=Math.floor(Math.random()*i.length);const n=i[s],a=i[c];if(!n.locked&&!a.locked){const r=n.periodIndex;n.periodIndex=a.periodIndex,a.periodIndex=r}}}let A=null,y=!1;self.onmessage=p=>{const{type:e,payload:t}=p.data;if(e==="START"){const{data:o,config:i}=t;console.log("Worker: Starting GA...",i),console.log("Worker: Initializing GA engine..."),A=new P(i);let s=A.initPopulation(o),c=0,n=-1;y=!0;const a=()=>{if(y)try{const r=A.evolve(s);s=r.population,c++,(c%10===0||r.bestScore>n)&&(n=r.bestScore,self.postMessage({type:"PROGRESS",payload:{generation:c,bestScore:r.bestScore,bestSolution:r.bestSolution}})),setTimeout(a,0)}catch(r){console.error("Worker Error during evolution:",r),y=!1}};setTimeout(a,0),console.log("Worker: Loop initialized.")}}})();
//# sourceMappingURL=scheduler.worker-BdTH5ltA.js.map
